# Markdown Upsert Pipeline Delegation

Last updated: 2026-02-12

## Goal
Run the markdown ingestion pipeline from `scripts/scraper/ircc_data_clean` into a Pinecone namespace with reliable validation and clear completion reporting.

## Pipeline Scope
Source files:
- `scripts/scraper/ircc_data_clean/*.md`

Ingestion script:
- `scripts/ingest_md/ingest_md.py`

Output target:
- Pinecone vectors in a chosen namespace

## Namespace Convention
Use a namespace that is explicit, versioned, and date-stamped:
- Format: `<corpus>-v<version>-<YYYYMMDD>`
- Example: `ircc-guidance-v1-20260212`

## Required Environment
Minimum required variables for Pinecone embedding + upsert:
- `PINECONE_API_KEY`
- `PINECONE_INDEX_HOST` or `PINECONE_INDEX_NAME`
- `PINECONE_NAMESPACE` (optional if passed as CLI flag)

Recommended embedding variables:
- `EMBEDDING_PROVIDER=pinecone`
- `EMBEDDING_MODEL=llama-text-embed-v2`
- `EMBEDDING_DIM=1024` (must match index dimension when used)
- `EMBEDDING_BASE_URL=https://api.pinecone.io`
- `PINECONE_API_VERSION=2025-10`

Python packages required:
- `python-frontmatter`
- `openai`
- `pinecone`
- `langchain-text-splitters`

## Preflight Checklist
1. Confirm markdown files exist:
```bash
find scripts/scraper/ircc_data_clean -type f -name '*.md' | wc -l
```
2. Confirm env variables are present (without exposing secrets):
```bash
python - <<'PY'
import os
for k in ["PINECONE_API_KEY","PINECONE_INDEX_HOST","PINECONE_INDEX_NAME","EMBEDDING_PROVIDER","EMBEDDING_MODEL","EMBEDDING_DIM"]:
    v = os.getenv(k)
    if v is None:
        print(f"{k}=<missing>")
    elif "KEY" in k:
        print(f"{k}=<set,len={len(v)}>")
    else:
        print(f"{k}={v}")
PY
```
3. Run one-file smoke test before full run:
```bash
python scripts/ingest_md/ingest_md.py \
  --directory scripts/scraper/ircc_data_clean \
  --namespace ircc-guidance-v1-20260212 \
  --max-files 1
```

## Full Upsert Command
```bash
python scripts/ingest_md/ingest_md.py \
  --directory scripts/scraper/ircc_data_clean \
  --namespace ircc-guidance-v1-20260212
```

## Expected Log Signals
Healthy run pattern:
- `Found <N> markdown files`
- `Processed <file>.md: <k> chunks`
- `Upserted batch of <k> vectors`
- Final summary includes:
  - `Files processed: <N>`
  - `Chunks embedded: <M>`
  - `Vectors upserted: <M or close>`

First-run note for a brand new namespace:
- You may see one early delete warning:
  - `Namespace not found`
- This is acceptable on first document delete attempt; upserts should still proceed.

## No-Upsert Chunk Preview (for review/debug)
To inspect chunking output without writing vectors, generate a local JSON preview from one markdown file:
- Example output files:
  - `tmp/chunk_preview_agreement-cuktca.json`
  - `tmp/chunk_preview_quebec-cases-81219c10e7.json`

## Known Failure Modes and Fixes
1. DNS/network resolution errors to Pinecone host
- Symptom: `Failed to resolve ...pinecone.io`
- Action: rerun in an environment with outbound DNS/network access.

2. Dimension mismatch on upsert
- Symptom: `Vector dimension 1536 does not match the dimension of the index 1024`
- Action:
  - Ensure embeddings are generated by provider/model matching index dimension.
  - Ensure `EMBEDDING_DIM` matches index dimension when Pinecone embed endpoint is used.

3. Missing markdown files
- Symptom: `Found 0 markdown files`
- Action: verify directory path and that `.md` files exist in `ircc_data_clean`.

4. Missing dependencies
- Symptom: `ModuleNotFoundError` for `frontmatter`, `pinecone`, etc.
- Action:
```bash
pip install python-frontmatter openai pinecone langchain-text-splitters
```

## Important Implementation Note
`scripts/ingest_md/ingest_md.py` was corrected so non-dry runs always call real embedding, including `EMBEDDING_PROVIDER=pinecone`.

This avoids dummy-vector behavior and prevents false `1536` dimension upserts.

## Agent Handoff Output Format
When delegating, require the agent to return:
1. Namespace used.
2. Exact command run.
3. Final ingestion summary block values.
4. First error encountered (if any) and resolution.
5. Confirmation that `Vectors upserted` is non-zero.

